{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "stage4_description_intel.schema.json",
  "title": "Stage 4 - Description Intelligence Output Schema",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "listing_id",
    "source_snapshot_id",
    "created_at",
    "stage_name",
    "stage_version",
    "ruleset_version",
    "llm_version",
    "payload"
  ],
  "properties": {
    "listing_id": { "type": "string", "minLength": 1 },
    "source_snapshot_id": { "type": "string", "minLength": 1 },
    "created_at": { "type": "string", "format": "date-time" },

    "stage_name": {
      "type": "string",
      "const": "stage4_description_intelligence"
    },
    "stage_version": { "type": "string", "minLength": 1 },
    "ruleset_version": { "type": "string", "minLength": 1 },
    "llm_version": {
      "type": ["string", "null"],
      "description": "Null when LLM was not used or unavailable."
    },

    "payload": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "risk_level_overall",
        "negotiation_stance",
        "claimed_condition",
        "service_history_level",
        "mods_risk_level",
        "signals",
        "maintenance",
        "missing_info",
        "follow_up_questions",
        "extraction_warnings",
        "source_text_stats"
      ],
      "properties": {
        "risk_level_overall": { "$ref": "#/$defs/risk_level_overall" },
        "negotiation_stance": { "$ref": "#/$defs/negotiation_stance" },
        "claimed_condition": { "$ref": "#/$defs/claimed_condition" },
        "service_history_level": { "$ref": "#/$defs/service_history_level" },
        "mods_risk_level": { "$ref": "#/$defs/mods_risk_level" },

        "signals": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "legality",
            "accident_history",
            "mechanical_issues",
            "cosmetic_issues",
            "mods_performance",
            "mods_cosmetic",
            "seller_behavior"
          ],
          "properties": {
            "legality": {
              "type": "array",
              "items": { "$ref": "#/$defs/signal_legality" },
              "default": []
            },
            "accident_history": {
              "type": "array",
              "items": { "$ref": "#/$defs/signal_accident" },
              "default": []
            },
            "mechanical_issues": {
              "type": "array",
              "items": { "$ref": "#/$defs/signal_mechanical" },
              "default": []
            },
            "cosmetic_issues": {
              "type": "array",
              "items": { "$ref": "#/$defs/signal_cosmetic" },
              "default": []
            },
            "mods_performance": {
              "type": "array",
              "items": { "$ref": "#/$defs/signal_mods_performance" },
              "default": []
            },
            "mods_cosmetic": {
              "type": "array",
              "items": { "$ref": "#/$defs/signal_mods_cosmetic" },
              "default": []
            },
            "seller_behavior": {
              "type": "array",
              "items": { "$ref": "#/$defs/signal_seller_behavior" },
              "default": []
            }
          }
        },

        "maintenance": {
          "type": "object",
          "additionalProperties": false,
          "required": ["claims", "evidence_present", "red_flags"],
          "properties": {
            "claims": {
              "type": "array",
              "items": { "$ref": "#/$defs/maintenance_claim" },
              "default": []
            },
            "evidence_present": {
              "type": "array",
              "items": { "$ref": "#/$defs/maintenance_evidence_present" },
              "default": []
            },
            "red_flags": {
              "type": "array",
              "items": { "$ref": "#/$defs/maintenance_red_flag" },
              "default": []
            }
          }
        },

        "missing_info": {
          "type": "array",
          "items": { "$ref": "#/$defs/missing_info" },
          "default": []
        },

        "follow_up_questions": {
          "type": "array",
          "items": { "$ref": "#/$defs/follow_up_question" },
          "default": []
        },

        "extraction_warnings": {
          "type": "array",
          "items": { "type": "string" },
          "default": []
        },

        "source_text_stats": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "title_length",
            "description_length",
            "contains_keywords_high_risk"
          ],
          "properties": {
            "title_length": { "type": "integer", "minimum": 0 },
            "description_length": { "type": "integer", "minimum": 0 },
            "contains_keywords_high_risk": { "type": "boolean" }
          }
        }
      }
    }
  },

  "$defs": {
    "confidence": {
      "type": "number",
      "minimum": 0,
      "maximum": 1
    },

    "verification_level": {
      "type": "string",
      "enum": ["verified", "inferred"]
    },

    "severity": {
      "type": "string",
      "enum": ["low", "medium", "high"]
    },

    "claimed_condition": {
      "type": "string",
      "enum": ["excellent", "good", "fair", "needs_work", "unknown"]
    },

    "service_history_level": {
      "type": "string",
      "enum": ["none", "partial", "full", "unknown"]
    },

    "mods_risk_level": {
      "type": "string",
      "enum": ["none", "low", "medium", "high", "unknown"]
    },

    "negotiation_stance": {
      "type": "string",
      "enum": ["open", "firm", "unknown"]
    },

    "risk_level_overall": {
      "type": "string",
      "enum": ["low", "medium", "high", "unknown"]
    },

    "signal_base": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "severity",
        "verification_level",
        "evidence_text",
        "confidence"
      ],
      "properties": {
        "type": { "type": "string" },
        "severity": { "$ref": "#/$defs/severity" },
        "verification_level": { "$ref": "#/$defs/verification_level" },
        "evidence_text": { "type": "string", "minLength": 1 },
        "confidence": { "$ref": "#/$defs/confidence" }
      }
    },

    "signal_legality_type": {
      "type": "string",
      "enum": [
        "no_rego",
        "rego_expired",
        "rego_short",
        "unregistered",
        "no_rwc",
        "rwc_required",
        "defected",
        "inspection_required",
        "not_roadworthy",
        "non_compliant_mods",
        "other"
      ]
    },

    "signal_accident_type": {
      "type": "string",
      "enum": [
        "writeoff",
        "repairable_writeoff",
        "rebuilt_title",
        "salvage_title",
        "wovr_listed",
        "accident_damage",
        "hail_damage",
        "flood_damage",
        "structural_damage",
        "airbag_deployed",
        "chassis_damage",
        "paintwork_repair",
        "panel_replacement",
        "other"
      ]
    },

    "signal_mechanical_type": {
      "type": "string",
      "enum": [
        "engine_knock",
        "engine_misfire",
        "engine_overheating",
        "oil_leak",
        "coolant_leak",
        "head_gasket_suspected",
        "smoke_from_exhaust",
        "rough_idle",
        "starting_issue",
        "gearbox_issue",
        "clutch_issue",
        "slipping_transmission",
        "diff_issue",
        "drivetrain_noise",
        "suspension_issue",
        "steering_issue",
        "brake_issue",
        "tyres_worn",
        "battery_issue",
        "alternator_issue",
        "electrical_fault",
        "check_engine_light",
        "needs_mechanic",
        "not_running",
        "intermittent_issue",
        "unknown_mechanical_issue",
        "other"
      ]
    },

    "signal_cosmetic_type": {
      "type": "string",
      "enum": [
        "scratch",
        "dent",
        "paint_fade",
        "clearcoat_peel",
        "rust_visible",
        "interior_wear",
        "cracked_windscreen",
        "broken_light",
        "missing_parts_cosmetic",
        "dirty_or_neglected",
        "other"
      ]
    },

    "signal_mods_performance_type": {
      "type": "string",
      "enum": [
        "tuned",
        "ecu_tune",
        "stage_1",
        "stage_2_or_higher",
        "turbo_upgrade",
        "turbo_swap",
        "supercharger",
        "engine_swap",
        "e85_flex_fuel",
        "intake_exhaust",
        "downpipe",
        "intercooler_upgrade",
        "fuel_system_upgrade",
        "track_use",
        "race_build",
        "other"
      ]
    },

    "signal_mods_cosmetic_type": {
      "type": "string",
      "enum": [
        "aftermarket_wheels",
        "bodykit",
        "wrap",
        "tint",
        "lowered",
        "lifted",
        "custom_lights",
        "interior_custom",
        "audio_upgrade",
        "other"
      ]
    },

    "signal_seller_behavior_type": {
      "type": "string",
      "enum": [
        "need_gone",
        "moving_sale",
        "urgent_sale",
        "price_drop_mentioned",
        "firm_price",
        "open_to_offers",
        "no_timewasters",
        "no_lowballers",
        "swap_trade",
        "cash_only",
        "deposit_required",
        "finance_available",
        "delivery_available",
        "transparent_disclosure",
        "vague_description",
        "contradictory_claims",
        "too_good_to_be_true_language",
        "other"
      ]
    },

    "signal_legality": {
      "allOf": [
        { "$ref": "#/$defs/signal_base" },
        {
          "properties": { "type": { "$ref": "#/$defs/signal_legality_type" } }
        }
      ]
    },

    "signal_accident": {
      "allOf": [
        { "$ref": "#/$defs/signal_base" },
        {
          "properties": { "type": { "$ref": "#/$defs/signal_accident_type" } }
        }
      ]
    },

    "signal_mechanical": {
      "allOf": [
        { "$ref": "#/$defs/signal_base" },
        {
          "properties": { "type": { "$ref": "#/$defs/signal_mechanical_type" } }
        }
      ]
    },

    "signal_cosmetic": {
      "allOf": [
        { "$ref": "#/$defs/signal_base" },
        {
          "properties": { "type": { "$ref": "#/$defs/signal_cosmetic_type" } }
        }
      ]
    },

    "signal_mods_performance": {
      "allOf": [
        { "$ref": "#/$defs/signal_base" },
        {
          "properties": {
            "type": { "$ref": "#/$defs/signal_mods_performance_type" }
          }
        }
      ]
    },

    "signal_mods_cosmetic": {
      "allOf": [
        { "$ref": "#/$defs/signal_base" },
        {
          "properties": { "type": { "$ref": "#/$defs/signal_mods_cosmetic_type" } }
        }
      ]
    },

    "signal_seller_behavior": {
      "allOf": [
        { "$ref": "#/$defs/signal_base" },
        {
          "properties": {
            "type": { "$ref": "#/$defs/signal_seller_behavior_type" }
          }
        }
      ]
    },

    "maintenance_claim_type": {
      "type": "string",
      "enum": [
        "serviced_recently",
        "regular_service_claimed",
        "logbook_mentioned",
        "receipts_mentioned",
        "major_service_done",
        "timing_belt_done",
        "water_pump_done",
        "clutch_replaced",
        "gearbox_rebuilt",
        "engine_rebuilt",
        "new_tyres",
        "new_brakes",
        "battery_replaced",
        "other"
      ]
    },

    "maintenance_claim": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "details", "evidence_text", "confidence", "verification_level"],
      "properties": {
        "type": { "$ref": "#/$defs/maintenance_claim_type" },
        "details": { "type": ["string", "null"] },
        "evidence_text": { "type": "string", "minLength": 1 },
        "confidence": { "$ref": "#/$defs/confidence" },
        "verification_level": { "$ref": "#/$defs/verification_level" }
      }
    },

    "maintenance_evidence_present": {
      "type": "string",
      "enum": ["logbook", "receipts", "workshop_invoice", "photos_of_records", "none", "other"]
    },

    "maintenance_red_flag_type": {
      "type": "string",
      "enum": [
        "claim_without_proof",
        "major_work_no_receipts",
        "inconsistent_service_story",
        "recent_issue_disguised_as_minor",
        "odometer_or_history_unclear",
        "other"
      ]
    },

    "maintenance_red_flag": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "severity", "verification_level", "evidence_text", "confidence"],
      "properties": {
        "type": { "$ref": "#/$defs/maintenance_red_flag_type" },
        "severity": { "$ref": "#/$defs/severity" },
        "verification_level": { "$ref": "#/$defs/verification_level" },
        "evidence_text": { "type": "string", "minLength": 1 },
        "confidence": { "$ref": "#/$defs/confidence" }
      }
    },

    "missing_info": {
      "type": "string",
      "enum": [
        "vin_unknown",
        "ppsr_or_finance_status_unknown",
        "rego_expiry_unknown",
        "rwc_status_unknown",
        "accident_history_unknown",
        "service_history_unknown",
        "number_of_owners_unknown",
        "reason_for_selling_unknown",
        "recent_repairs_proof_unknown",
        "mods_engineered_unknown",
        "inspection_availability_unknown",
        "other"
      ]
    },

    "question_priority": {
      "type": "string",
      "enum": ["high", "medium", "low"]
    },

    "driven_by": {
      "type": "string",
      "description": "Drivers should reference stage4 signal types and/or missing_info enums."
    },

    "follow_up_question": {
      "type": "object",
      "additionalProperties": false,
      "required": ["question", "reason", "priority", "driven_by"],
      "properties": {
        "question": { "type": "string", "minLength": 5 },
        "reason": { "type": "string", "minLength": 3 },
        "priority": { "$ref": "#/$defs/question_priority" },
        "driven_by": {
          "type": "array",
          "items": { "$ref": "#/$defs/driven_by" },
          "default": []
        }
      }
    }
  }
}